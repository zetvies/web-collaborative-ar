<!DOCTYPE html>

<head>
  <meta name="viewport" content="width=device-width, user-scalable=no, minimum-scale=1.0, maximum-scale=1.0">
  <title>Hello, world!</title>
  <!-- include three.js library -->
  <script src='libs/three.min.js'></script>
  <!-- include jsartookit -->
  <script src="jsartoolkit5/artoolkit.min.js"></script>
  <script src="jsartoolkit5/artoolkit.api.js"></script>
  <!-- include threex.artoolkit -->
  <script src="threex/threex-artoolkitsource.js"></script>
  <script src="threex/threex-artoolkitcontext.js"></script>
  <script src="threex/threex-arbasecontrols.js"></script>
  <script src="threex/threex-armarkercontrols.js"></script>
  <script src="threex/threex-domevents.js"></script>
  <!-- include other scripts -->
  <script src="libs/inflate.min.js"></script>
  <script src="libs/FBXLoader.js"></script>
  <script src="libs/OrbitControls.js"></script>
  <script src="libs/Detector.js"></script>
</head>

<body style='margin : 0px; overflow: hidden; font-family: Monospace;'>

  <!-- 
  Example created by Lee Stemkoski: https://github.com/stemkoski
  Based on the AR.js library and examples created by Jerome Etienne: https://github.com/jeromeetienne/AR.js/
-->


  <script>

    var scene, camera, renderer, clock, deltaTime, totalTime;

    var arToolkitSource, arToolkitContext;

    var environment, interactables;

    var raycastObjects = []

    var HotdogBuilding, DonutBuilding, IceCreamBuilding, ShortBuilding, TallBuilding;

    let state = 0;

    var material1, mesh1;

    let raycaster = new THREE.Raycaster();
    let mouse = new THREE.Vector2();

    initialize();
    animate();

    function initialize() {
      scene = new THREE.Scene();

      camera = new THREE.PerspectiveCamera(45, 1, 1, 1000);
      scene.add(camera);

      renderer = new THREE.WebGLRenderer({
        antialias: true,
        alpha: true
      });
      renderer.setClearColor(new THREE.Color('lightgrey'), 0)
      renderer.setSize(640, 480);
      renderer.domElement.style.position = 'absolute'
      renderer.domElement.style.top = '0px'
      renderer.domElement.style.left = '0px'
      document.body.appendChild(renderer.domElement);

      clock = new THREE.Clock();
      deltaTime = 0;
      totalTime = 0;

      ////////////////////////////////////////////////////////////
      // setup arToolkitSource
      ////////////////////////////////////////////////////////////

      arToolkitSource = new THREEx.ArToolkitSource({
        sourceType: 'webcam',
      });

      function onResize() {
        arToolkitSource.onResizeElement()
        arToolkitSource.copyElementSizeTo(renderer.domElement)
        if (arToolkitContext.arController !== null) {
          arToolkitSource.copyElementSizeTo(arToolkitContext.arController.canvas)
        }
      }

      arToolkitSource.init(function onReady() {
        onResize()
      });

      // handle resize event
      window.addEventListener('resize', function () {
        onResize()
      });

      ////////////////////////////////////////////////////////////
      // setup arToolkitContext
      ////////////////////////////////////////////////////////////	

      // create atToolkitContext
      arToolkitContext = new THREEx.ArToolkitContext({
        cameraParametersUrl: 'data/camera_para.dat',
        detectionMode: 'mono'
      });

      // copy projection matrix to camera when initialization complete
      arToolkitContext.init(function onCompleted() {
        camera.projectionMatrix.copy(arToolkitContext.getProjectionMatrix());
      });

      ////////////////////////////////////////////////////////////
      // setup markerRoots
      ////////////////////////////////////////////////////////////

      // build markerControls
      environment = new THREE.Group();
      scene.add(environment);
      let markerControls1 = new THREEx.ArMarkerControls(arToolkitContext, environment, {
        type: 'pattern', patternUrl: "data/kanji.patt",
      })

      ////////////////////////////////////////////////////////////
      // setup scene
      ////////////////////////////////////////////////////////////

      renderer.shadowMap.enabled = true;
      renderer.shadowMap.type = THREE.PCFSoftShadowMap;

      let loader = new THREE.TextureLoader();

      interactables = new THREE.Group();
      environment.add(interactables);

      let texture = loader.load("images/color-grid.png");
      // repeat texture
      texture.wrapS = THREE.RepeatWrapping;
      texture.wrapT = THREE.RepeatWrapping;
      texture.repeat.set(8, 1);

      shadowMesh = new THREE.Mesh(
        new THREE.TorusKnotGeometry(0.5, 0.2, 128, 16), // new THREE.SphereBufferGeometry(1, 32, 32), 
        new THREE.MeshLambertMaterial({ map: texture })
      );
      shadowMesh.position.y = 1;
      shadowMesh.castShadow = true;
      shadowMesh.receiveShadow = true;
      // interactables.add(shadowMesh);
      shadowMesh.name = "Torus";

      let floader = new THREE.FBXLoader();
      floader.load('assets/fbx/HotdogBuilding.fbx', function (object) {
        object.scale.multiplyScalar(0.00045);
        object.name = "Building"
        object.children.forEach(child => {
          child.name = "Building"
        })
        HotdogBuilding = object
      }, undefined, function (e) {
        console.error(e);
      });

      floader.load('assets/fbx/DonutBuilding.fbx', function (object) {
        object.scale.multiplyScalar(0.00045);
        object.name = "Building"
        object.children.forEach(child => {
          child.name = "Building"
        })
        DonutBuilding = object
      }, undefined, function (e) {
        console.error(e);
      });

      floader.load('assets/fbx/IceCreamBuilding.fbx', function (object) {
        object.scale.multiplyScalar(0.00045);
        object.name = "Building"
        object.children.forEach(child => {
          child.name = "Building"
        })
        IceCreamBuilding = object
      }, undefined, function (e) {
        console.error(e);
      });

      floader.load('assets/fbx/ShortBuilding.fbx', function (object) {
        object.scale.multiplyScalar(0.00045);
        object.name = "Building"
        object.children.forEach(child => {
          child.name = "Building"
        })
        ShortBuilding = object
      }, undefined, function (e) {
        console.error(e);
      });


      floader.load('assets/fbx/TallBuilding.fbx', function (object) {
        object.scale.multiplyScalar(0.00045);
        object.name = "Building"
        object.children.forEach(child => {
          child.name = "Building"
        })
        TallBuilding = object
      }, undefined, function (e) {
        console.error(e);
      });


      // let floorGeometry = new THREE.PlaneGeometry(2,2);
      // let floorMaterial = new THREE.MeshStandardMaterial();
      // let floorMesh = new THREE.Mesh(floorGeometry, floorMaterial);
      // floorMesh.rotation.x = -Math.PI / 2;
      // // floorMesh.receiveShadow = true;
      // interactables.add(floorMesh);

      let foundationGeometry = new THREE.BoxGeometry(1, 0.1, 1);
      let foundationMaterial = new THREE.MeshStandardMaterial({ color: 0x808080 });
      foundationMesh = new THREE.Mesh(foundationGeometry, foundationMaterial);
      foundationMesh.receiveShadow = true;
      foundationMesh.position.y = 0.05;
      foundationMesh.name = "AF"


      let light = new THREE.PointLight(0xffffff, 1, 100);
      light.position.set(0, 4, 0); // default; light shining from top
      light.castShadow = true;
      environment.add(light);

      let lightSphere = new THREE.Mesh(
        new THREE.SphereGeometry(0.1),
        new THREE.MeshBasicMaterial({
          color: 0xffffff,
          transparent: true,
          opacity: 0.8
        })
      );
      lightSphere.position.copy(light.position);
      environment.add(lightSphere);

      let ambientLight = new THREE.AmbientLight(0x666666);
      environment.add(ambientLight);
      // let helper = new THREE.CameraHelper( light.shadow.camera );
      // interactables.add( helper );
    }


    function isTouch() {
      let check = false;
      (function (a) { if (/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino|android|ipad|playbook|silk/i.test(a) || /1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0, 4))) check = true; })(navigator.userAgent || navigator.vendor || window.opera);
      return check;
    };

    function onMouseMove(event) {

      // calculate mouse position in normalized device coordinates
      // (-1 to +1) for both components

      mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
      mouse.y = - (event.clientY / window.innerHeight) * 2 + 1;

    }

    function hover() {
      raycaster.setFromCamera(mouse, camera);
      const intersects = raycaster.intersectObjects(raycastObjects, true);
      if (intersects[0]) {

        if (intersects[0].object.name == "AF") {
          intersects[0].object.material.transparent = true
          intersects[0].object.material.opacity = 0.5;
        }
        if (intersects[0].object.name == "Building") {
          intersects[0].object.material.forEach(function (child) {
            child.transparent = true
            child.opacity = 0.5;
          });
        }
      }
    }

    function resetMaterials() {
      for (let i = 0; i < raycastObjects.length; i++) {
        if (raycastObjects[i].material && raycastObjects[i].name == "AF") {
          raycastObjects[i].material.opacity = 1;
        }
        if (raycastObjects[i] && raycastObjects[i].name == "Building") {
          raycastObjects[i].children.forEach(function (child) {
            // console.log(child.name)
            child.material.forEach(function (material) {
              material.opacity = 1;
            });
          })
        }
      }
    }

    let clicked = false

    function onClick(event) {
      raycaster.setFromCamera(mouse, camera);
      const intersects = raycaster.intersectObjects(raycastObjects, true);
      if (intersects[0]) {
        if (state == 5) {
          state = 0
        }
        else state++

        // console.log(intersects[0].object.name, interactables.children[0].children[0].material)
      }

      console.log(window, isTouch())
    }


    window.addEventListener('mousemove', onMouseMove, false);
    window.addEventListener('click', onClick);

    function update() {
      // update artoolkit on every frame
      if (arToolkitSource.ready !== false)
        arToolkitContext.update(arToolkitSource.domElement);
    }

    function render() {
      renderer.render(scene, camera);
    }


    function loadObjects() {
      raycastObjects = []

      while (interactables.children.length > 0) {
        interactables.remove(interactables.children[0]);
      }

      if (state == 0) {
        interactables.add(foundationMesh);
      }
      else if (state == 1) {
        interactables.add(HotdogBuilding)
      }
      else if (state == 2) {
        interactables.add(DonutBuilding)
      }
      else if (state == 3) {
        interactables.add(IceCreamBuilding)
      }
      else if (state == 4) {
        interactables.add(ShortBuilding)
      }
      else if (state == 5) {
        interactables.add(TallBuilding)
      }


      raycastObjects = interactables.children
    }

    function animate() {
      requestAnimationFrame(animate);
      deltaTime = clock.getDelta();
      totalTime += deltaTime;
      loadObjects()
      if (!isTouch()) {
        resetMaterials();
        hover();
      }
      update();
      render();
    }

  </script>

</body>

</html>